# klaviyo-ct-plugin

The [Klaviyo](https://www.klaviyo.com/) plugin for [commercetools](https://commercetools.com/) is a Node.js application
that provides the ability to sync commercetools data into Klaviyo.

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [Overview](#overview)
- [Supported features](#supported-features)
- [Plugin installation](#plugin-installation)
- [How it works](#how-it-works)
- [Plugin development and customization](#plugin-development-and-customization)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Overview

The plugin acquires data from commercetools in two different ways:

- **Realtime data** - events are received asynchronously via
  commercetools [subscriptions](https://docs.commercetools.com/api/projects/subscriptions),
  e.g. on order creation, customer creation, etc. On receipt of these events, relevant data is fetched (if necessary)
  from commercetools and synced in to Klaviyo.
- **Bulk import** - a set of API endpoints are provided to manually trigger the data sync into Klaviyo. Typical use
  cases include the synchronization of the product catalogue or of historical customers and orders. This is typically
  performed when installing the plugin for the first time but can also be done periodically if the data becomes out of
  sync.

![Klaviyo CT Plugin architecture](./docs/img/arch_diagram.png "Klaviyo Commercetools Plugin Architecture")

## Supported features

Real-time data sync:

- Customer creation
- Customer update
- Order placed
- Order fulfilled
- Order cancelled
- Order refunded (single refund)
- Category created
- Category updated
- Category deleted
- Product deleted

Bulk data import:

- Orders
- Product Catalogue and categories
- Customers

Check [data flow](docs/plugin-development-customization.md#data-flow) for all the details about the data exchanged
between commercetools and Klaviyo.

## Plugin installation

See [plugin installation documentation](docs/plugin-installation.md)

## How it works

See [how it works](docs/how-it-works.md) for the details on how the data is synced between commercetools and Klaviyo.

## Plugin development and customization

The process of setting up commercetools can differ based on the specific implementation, and the integration needs may
also vary in each scenario. Due to these variations, the plugin is distributed as an open source application to
facilitate the integration of these systems. This way, individuals are able to freely download, host, and customize the
solution according to their distinct business needs.  
See [plugin development and customization documentation](docs/plugin-development-customization.md) for all the details
on how to customize the plugin.

## Executing the code

- Once the codebase has been checked out, first resolve all the dependencies by executing `npm i` at the root of the codebase on the terminal
- Create a copy of the file - `.env.test` and rename it to `.env`
- Update the below properties with the appropriate values as described:
```
CT_API_CLIENT={"clientId":"<CLIENT_ID>","secret":"<SECRET>"}
CT_SCOPES='manage_project:klaviyo-dev'
KLAVIYO_AUTH_KEY=<KLAVIYO_AUTH_KEY>
```
**NOTE:**
> The property `CT_API_CLIENT` is set with the values that are generated when the developer creates their API client credentials on commercetools
>
> The property `CT_SCOPES` has the value - `manage_project:klaviyo-dev` because usually we create the API client with admin privileges. If the developer creates their API client with specific scopes, then this property should be set with the appropriate values/scopes.
>
> The property - `KLAVIYO_AUTH_KEY` is set with the key that is generated in the klaviyo account settings. Usually this key is also generated by requesting the admin-level access by the developers.
- Save the `.env` file
- On your terminal, execute the command - `npm run start`

## Testing a component

- We could test either the pub/sub adapter or the bulk sync components using postman.
- Open postman and create a HTTP POST request
- Provide the URL as `localhost:6789` for hitting the pub/sub adapter and  `localhost:6779` for the bulk sync component.
- No authentication parameters are needed to be set when testing locally.
- Select the request body type as `application/json`
- Provide the request body in the below format:
```
{
  "message": {
  "data": "eyJ2ZXJzaW9uIjo2LCJwcm9qZWN0S2V5Ijoia2xhdml5by1kZXYiLCJyZXNvdXJjZSI6eyJ0eXBlSWQiOiJjYXRlZ29yeSIsImlkIjoiYjIxOGMwOWQtYWFkNy00NjBiLTlkYTMtZDkxYTRmYjhjNGI3In0sIm1vZGlmaWVkQXQiOiIyMDIzLTAyLTA2VDE2OjEzOjIzLjUyOFoiLCJub3RpZmljYXRpb25UeXBlIjoiUmVzb3VyY2VVcGRhdGVkIiwicmVzb3VyY2VVc2VyUHJvdmlkZWRJZGVudGlmaWVycyI6eyJrZXkiOiJ0ZXN0Y3VzdG9tZXIifSwib2xkVmVyc2lvbiI6NX0="
  }
}
```
**NOTE:**
The value of the `data` field is actual data object (JSON) that is stringified and then base64 encoded. A suggestion on how to do this is given below:
- On your browser, open developer settings
- On the console, simply assign the object you want to send in the request body to a var for ex: `obj`.  
- Stringify `obj` using `JSON.stringify(obj)` and do not close the dev tools console yet.
- On your browser, open https://www.base64encode.org/ and select `Encode` as the mode of operation
- Copy the stringified output of the data object from the dev tools console and paste it in the box and click on the `> Encode <` button.
- Copy the generated value from the result box and paste it as the value of the `data` field in the request body on the postman request and hit the `Send` button
- Verify the results and the logs on your termial.


## Contributing

We appreciate any and all contributions to this project! Before creating an issue or raising a PR, review our
[Contributing guide](./docs/CONTRIBUTING.md). This guide reviews issue creation, prerequisites for pull requests, and
more.
